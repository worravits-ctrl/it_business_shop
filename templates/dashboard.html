{% extends 'base.html' %}
{% block content %}
<div class="row mb-4">
  <div class="col-12">
    <h1 class="display-6 fw-bold text-primary mb-0">
      <i class="fas fa-chart-line me-3"></i>Dashboard
    </h1>
    <p class="text-muted">ภาพรวมรายรับ-รายจ่ายของร้าน IT Business Shop</p>
  </div>
</div>

<!-- สถิติรายวัน -->
<div class="row mb-4">
  <div class="col-12">
    <h5 class="fw-bold mb-3">
      <i class="fas fa-calendar-day me-2 text-primary"></i>สถิติรายวัน (วันนี้)
    </h5>
  </div>
</div>

<div class="row mb-5">
  <div class="col-md-4">
    <div class="card stat-card income-card">
      <div class="stat-icon income-icon">
        <i class="fas fa-arrow-trend-up"></i>
      </div>
      <div class="stat-value text-success">{{ "{:,.0f}".format(t_inc) }}</div>
      <div class="stat-label">รายรับวันนี้</div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card stat-card expense-card">
      <div class="stat-icon expense-icon">
        <i class="fas fa-arrow-trend-down"></i>
      </div>
      <div class="stat-value text-danger">{{ "{:,.0f}".format(t_exp) }}</div>
      <div class="stat-label">รายจ่ายวันนี้</div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card stat-card profit-card">
      <div class="stat-icon profit-icon">
        <i class="fas fa-coins"></i>
      </div>
      <div class="stat-value {{ 'text-success' if t_net >= 0 else 'text-danger' }}">
        {{ "{:,.0f}".format(t_net) }}
      </div>
      <div class="stat-label">กำไรวันนี้</div>
    </div>
  </div>
</div>

<!-- สถิติรายเดือน -->
<div class="row mb-4">
  <div class="col-12">
    <h5 class="fw-bold mb-3">
      <i class="fas fa-calendar-alt me-2 text-primary"></i>สถิติรายเดือน (เดือนนี้)
    </h5>
  </div>
</div>

<div class="row mb-5">
  <div class="col-md-4">
    <div class="card stat-card income-card">
      <div class="stat-icon income-icon">
        <i class="fas fa-chart-line"></i>
      </div>
      <div class="stat-value text-success">{{ "{:,.0f}".format(m_inc) }}</div>
      <div class="stat-label">รายรับเดือนนี้</div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card stat-card expense-card">
      <div class="stat-icon expense-icon">
        <i class="fas fa-chart-line-down"></i>
      </div>
      <div class="stat-value text-danger">{{ "{:,.0f}".format(m_exp) }}</div>
      <div class="stat-label">รายจ่ายเดือนนี้</div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card stat-card profit-card">
      <div class="stat-icon profit-icon">
        <i class="fas fa-hand-holding-dollar"></i>
      </div>
      <div class="stat-value {{ 'text-success' if m_net >= 0 else 'text-danger' }}">
        {{ "{:,.0f}".format(m_net) }}
      </div>
      <div class="stat-label">กำไรเดือนนี้</div>
    </div>
  </div>
</div>

<!-- สถิติรายปี -->
<div class="row mb-4">
  <div class="col-12">
    <h5 class="fw-bold mb-3">
      <i class="fas fa-calendar me-2 text-primary"></i>สถิติรายปี (ปีนี้)
    </h5>
  </div>
</div>

<div class="row mb-5">
  <div class="col-md-4">
    <div class="card stat-card income-card">
      <div class="stat-icon income-icon">
        <i class="fas fa-chart-area"></i>
      </div>
      <div class="stat-value text-success">{{ "{:,.0f}".format(y_inc) }}</div>
      <div class="stat-label">รายรับปีนี้</div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card stat-card expense-card">
      <div class="stat-icon expense-icon">
        <i class="fas fa-chart-area"></i>
      </div>
      <div class="stat-value text-danger">{{ "{:,.0f}".format(y_exp) }}</div>
      <div class="stat-label">รายจ่ายปีนี้</div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card stat-card profit-card">
      <div class="stat-icon profit-icon">
        <i class="fas fa-trophy"></i>
      </div>
      <div class="stat-value {{ 'text-success' if y_net >= 0 else 'text-danger' }}">
        {{ "{:,.0f}".format(y_net) }}
      </div>
      <div class="stat-label">กำไรปีนี้</div>
    </div>
  </div>
</div>

<!-- กราฟแสดงแนวโน้ม -->
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">
          <i class="fas fa-chart-bar me-2"></i>แนวโน้มรายรับ-รายจ่าย รายเดือน
        </h5>
        <!-- Dropdown สำหรับเลือกเดือน/ปี -->
        <div class="d-flex gap-2">
          <select id="monthSelect" class="form-select form-select-sm" style="width: auto;">
            <option value="">เลือกเดือน</option>
            <option value="1">มกราคม</option>
            <option value="2">กุมภาพันธ์</option>
            <option value="3">มีนาคม</option>
            <option value="4">เมษายน</option>
            <option value="5">พฤษภาคม</option>
            <option value="6">มิถุนายน</option>
            <option value="7">กรกฎาคม</option>
            <option value="8">สิงหาคม</option>
            <option value="9">กันยายน</option>
            <option value="10">ตุลาคม</option>
            <option value="11">พฤศจิกายน</option>
            <option value="12">ธันวาคม</option>
          </select>
          <select id="yearSelect" class="form-select form-select-sm" style="width: auto;">
            <option value="">เลือกปี</option>
          </select>
          <button id="updateChart" class="btn btn-light btn-sm">
            <i class="fas fa-sync-alt"></i> อัปเดต
          </button>
        </div>
      </div>
      <div class="card-body">
        <div id="chartLoading" class="text-center py-4 d-none">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">กำลังโหลด...</span>
          </div>
          <p class="mt-2 text-muted">กำลังโหลดข้อมูล...</p>
        </div>
        <canvas id="incomeExpenseChart" width="400" height="150"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- ปุ่มด่วน -->
<div class="row mt-5">
  <div class="col-12">
    <h5 class="fw-bold mb-3">
      <i class="fas fa-bolt me-2 text-warning"></i>เมนูด่วน
    </h5>
  </div>
</div>

<div class="row">
  <div class="col-md-3 col-sm-6 mb-3">
    <a href="{{ url_for('entry_new') }}" class="text-decoration-none">
      <div class="card text-center h-100" style="border-left: 5px solid #059669;">
        <div class="card-body">
          <i class="fas fa-plus-circle fa-2x text-success mb-3"></i>
          <h6 class="card-title">เพิ่มรายการใหม่</h6>
          <p class="card-text text-muted">บันทึกรายรับ-รายจ่าย</p>
        </div>
      </div>
    </a>
  </div>
  <div class="col-md-3 col-sm-6 mb-3">
    <a href="{{ url_for('entries') }}" class="text-decoration-none">
      <div class="card text-center h-100" style="border-left: 5px solid #2563eb;">
        <div class="card-body">
          <i class="fas fa-list fa-2x text-primary mb-3"></i>
          <h6 class="card-title">ดูรายการทั้งหมด</h6>
          <p class="card-text text-muted">รายการรายรับ-รายจ่าย</p>
        </div>
      </div>
    </a>
  </div>
  <div class="col-md-3 col-sm-6 mb-3">
    <a href="{{ url_for('export_csv') }}" class="text-decoration-none">
      <div class="card text-center h-100" style="border-left: 5px solid #d97706;">
        <div class="card-body">
          <i class="fas fa-file-export fa-2x text-warning mb-3"></i>
          <h6 class="card-title">ส่งออกข้อมูล</h6>
          <p class="card-text text-muted">ดาวน์โหลด CSV</p>
        </div>
      </div>
    </a>
  </div>
  <div class="col-md-3 col-sm-6 mb-3">
    <a href="/simple-import" class="text-decoration-none">
      <div class="card text-center h-100" style="border-left: 5px solid #10b981;">
        <div class="card-body">
          <i class="fas fa-cloud-upload-alt fa-2x text-success mb-3"></i>
          <h6 class="card-title">นำเข้าข้อมูล CSV</h6>
          <p class="card-text text-muted">อัปโหลดแบบง่าย รวดเร็ว</p>
        </div>
      </div>
    </a>
  </div>
</div>

<script>
let chartInstance = null;

document.addEventListener('DOMContentLoaded', function() {
  const ctx = document.getElementById('incomeExpenseChart').getContext('2d');
  const monthSelect = document.getElementById('monthSelect');
  const yearSelect = document.getElementById('yearSelect');
  const updateButton = document.getElementById('updateChart');
  const chartLoading = document.getElementById('chartLoading');
  
  // ตั้งค่าเริ่มต้นเป็นเดือน/ปีปัจจุบัน
  const now = new Date();
  const currentMonth = now.getMonth() + 1;
  const currentYear = now.getFullYear();
  
  monthSelect.value = currentMonth;
  
  // โหลดปีที่มีข้อมูล
  loadAvailableYears();
  
  // สร้าง chart เริ่งต้น
  initChart();
  
  // Event listeners
  updateButton.addEventListener('click', updateChart);
  monthSelect.addEventListener('change', updateChart);
  yearSelect.addEventListener('change', updateChart);
  
  function initChart() {
    chartInstance = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'รายรับ',
          data: [],
          borderColor: '#059669',
          backgroundColor: 'rgba(5, 150, 105, 0.1)',
          borderWidth: 3,
          fill: true,
          tension: 0.4,
          pointBackgroundColor: '#059669',
          pointBorderColor: '#ffffff',
          pointBorderWidth: 2,
          pointRadius: 6
        }, {
          label: 'รายจ่าย',
          data: [],
          borderColor: '#dc2626',
          backgroundColor: 'rgba(220, 38, 38, 0.1)',
          borderWidth: 3,
          fill: true,
          tension: 0.4,
          pointBackgroundColor: '#dc2626',
          pointBorderColor: '#ffffff',
          pointBorderWidth: 2,
          pointRadius: 6
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: true,
            position: 'top',
            labels: {
              usePointStyle: true,
              padding: 20,
              font: {
                size: 14,
                weight: '600'
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: {
              color: 'rgba(0, 0, 0, 0.1)'
            },
            ticks: {
              callback: function(value) {
                return value.toLocaleString() + ' ฿';
              },
              font: {
                size: 12
              }
            }
          },
          x: {
            grid: {
              color: 'rgba(0, 0, 0, 0.1)'
            },
            ticks: {
              font: {
                size: 12
              }
            }
          }
        },
        interaction: {
          intersect: false,
          mode: 'index'
        },
        elements: {
          point: {
            hoverRadius: 8
          }
        }
      }
    });
    
    // โหลดข้อมูลเริ่มต้น
    updateChart();
  }
  
  async function loadAvailableYears() {
    try {
      const response = await fetch('/api/available-months');
      const data = await response.json();
      
      if (data.available) {
        const years = [...new Set(data.available.map(item => item.year))].sort((a, b) => b - a);
        
        yearSelect.innerHTML = '<option value="">เลือกปี</option>';
        years.forEach(year => {
          const option = document.createElement('option');
          option.value = year;
          option.textContent = year + 543; // แสดงเป็นปี พ.ศ.
          if (year === currentYear) {
            option.selected = true;
          }
          yearSelect.appendChild(option);
        });
      }
    } catch (error) {
      console.error('Error loading available years:', error);
      // ถ้าโหลดไม่ได้ ใช้ปีปัจจุบัน
      yearSelect.innerHTML = `<option value="${currentYear}" selected>${currentYear + 543}</option>`;
    }
  }
  
  async function updateChart() {
    const selectedMonth = monthSelect.value;
    const selectedYear = yearSelect.value;
    
    if (!selectedMonth || !selectedYear) {
      return;
    }
    
    // แสดง loading
    chartLoading.classList.remove('d-none');
    chartInstance.canvas.style.opacity = '0.3';
    
    try {
      const response = await fetch(`/api/chart-data?month=${selectedMonth}&year=${selectedYear}`);
      const data = await response.json();
      
      if (data.error) {
        throw new Error(data.error);
      }
      
      // อัปเดต chart
      chartInstance.data.labels = data.labels;
      chartInstance.data.datasets[0].data = data.incomes;
      chartInstance.data.datasets[1].data = data.expenses;
      chartInstance.update('active');
      
      // แสดงเดือน/ปีที่เลือกในหัวข้อ
      const monthNames = ['', 'มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน', 
                         'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'];
      const title = document.querySelector('.card-header h5');
      title.innerHTML = `<i class="fas fa-chart-bar me-2"></i>แนวโน้มรายรับ-รายจ่าย: ${monthNames[selectedMonth]} ${parseInt(selectedYear) + 543}`;
      
    } catch (error) {
      console.error('Error updating chart:', error);
      alert('เกิดข้อผิดพลาดในการโหลดข้อมูล: ' + error.message);
    } finally {
      // ซ่อน loading
      chartLoading.classList.add('d-none');
      chartInstance.canvas.style.opacity = '1';
    }
  }
});
</script>
{% endblock %}
